## TASK 1.3.5 [задание на stepik](https://stepik.org/lesson/297515/step/5?unit=279275)
Для каждого автора вычислить суммарную стоимость книг **S** (имя столбца **Стоимость**), а также вычислить налог на добавленную
стоимость  для полученных сумм (имя столбца **НДС** ) , который **включен в стоимость** и составляет 18% (**k=18**),  а также стоимость
книг  (**Стоимость_без_НДС**) без него. Значения округлить до двух знаков после запятой. В запросе для расчета НДС(**tax**)  и 
Стоимости без НДС(**S_without_tax**) использовать следующие формулы:

[![59.png](https://i.postimg.cc/qq06wTsB/59.png)](https://postimg.cc/0MWN5hXh)

**Пояснение:**

Имена столбцов, присвоенные им с помощью ```AS```, нельзя использовать в выражениях, используйте названия столбцов исходной таблицы.

**Решение:**

```SQL
SELECT
    author, 
    SUM(price*amount) AS Стоимость,
    ROUND((SUM(price*amount) * 18 / 100) / (1 + 18 / 100),2) AS НДС,
    ROUND(SUM(price*amount) / (1 + 18 / 100),2) AS Стоимость_без_НДС
FROM book
GROUP BY author;
```

**Перевод на человеческий:**

```SQL
/*выбери
   столбец author,
   вычисли суммарную стоимость книг, новый результирующий столбец назови "Стоимость",
   вычисли налог на добавленную стоимость суммарной стоимости книг, округли результат до 2-х знаков после запятой, новый результирующий столбец назови НДС, 
   вычисли стоимость книг без НДС, округли результат до 2-х знаков после запятой, новый результирующий столбец назови Стоимость_без_НДС*/
/*из таблицы book*/
/*сделай группировку по столбцу author*/
```

**Результат:**

```SQL
+------------------+-----------+---------+-------------------+
| author           | Стоимость | НДС     | Стоимость_без_НДС |
+------------------+-----------+---------+-------------------+
| Булгаков М.А.    | 4715.47   | 719.31  | 3996.16           |
| Достоевский Ф.М. | 11802.03  | 1800.31 | 10001.72          |
| Есенин С.А.      | 9750.00   | 1487.29 | 8262.71           |
+------------------+-----------+---------+-------------------+
Affected rows: 3
```

**Пояснение:**

- для выполнения запроса нам прежде всего необходимо сделать группировку по столбцу **author** с помощью оператора ```GROUP BY```.
В результате этой группировки значения с одинаковыми ФИО автора объединятся в группы и в результирующем наборе мы получим 3 группы авторов.
С этим набором и будет уже работать оператор ```SELECT```
- группировка нам нужна была для того, чтобы ```SELECT``` смог производить различные вычисления с помощью агрегатных функций:
   - у столбца **author** мы никаких вычислений не запрашиваем, он у нас просто будет как есть в результирующей таблице
   - далее мы запрашиваем вычисления и результат задаём вывести в новых столбцах (которых ещё не было в таблице), в данном задании
  для вычислений у нас есть конкретные формулы рассчётов **tax** и **S_without_tax**
   - сначала нам необходимо сосчитать суммарную стоимость книг, которая в формулах представлена как **S**. Для этого нам нужно перемножить значения
  столбцов с ценой и количеством книг (**price*amount**) и полученный результат суммировать с помощью агрегатной функции ```SUM()``` по каждому автору.
  Новый результирующий столбец называем "Стоимость" с помощью ключевого слова ```AS```
   - далее нам дано рассчитать **НДС** по формуле **tax**. Мы не можем использовать имя столбца, присвоенное с помощью ```AS```, поэтому в расчетах
  мы будем прописывать полностью **SUM(price*amount)** там, где в формулах используется **S**. Соответственно наш рассчет по формуле **tax** выглядит как
  **(SUM(price*amount) * 18 / 100) / (1 + 18 / 100)**. Также нам надо ещё округлить полученный результат до 2-х знаков после запятой. Для этого
  используем оператор ```ROUND(..., 2)```. На место ... вставляем наш рассчёт, не забываем заключить его целиком ещё в одни **скобки!**.
  Новый результирующий столбец называем "НДС" с помощью ключевого слова ```AS```
   - далее рассчитываем стоимость книг без НДС по формуле **S_without_tax**, округляем до 2-х знаков после запятой с помощью оператора ```ROUND(..., 2)```
  и присваиваем новому результирующему столбцу имя "Стоимость_без_НДС" с помощью ключевого слова ```AS```

Рассчёты в коде я расписала подробно для наглядности - в точном соответствии с формулами. Но на практике можно конечно сразу упрощать для облегчения
конструкции и читабельности кода, например, так:

```SQL
SELECT author, 
       SUM(price*amount) AS Стоимость,
       ROUND(SUM(price*amount) * 0.18 / 1.18, 2) AS НДС,
       ROUND(SUM(price*amount) / 1.18, 2) AS Стоимость_без_НДС
FROM book
GROUP BY author;
```
