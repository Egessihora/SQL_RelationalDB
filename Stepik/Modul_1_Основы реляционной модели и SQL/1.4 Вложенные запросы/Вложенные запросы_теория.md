SQL позволяет создавать вложенные запросы. 

Вложенный запрос (подзапрос, внутренний запрос) – это запрос внутри другого запроса SQL.

Вложенный запрос используется для выборки данных, которые будут использоваться в условии отбора записей основного запроса. Его применяют для:

- сравнения выражения с результатом вложенного запроса;
- определения того, включено ли выражение в результаты вложенного запроса;
- проверки того, выбирает ли запрос определенные строки.

Вложенный запрос имеет следующие компоненты:

- ключевое слово ```SELECT```  после которого указываются имена столбцов или выражения (чаще всего список содержит один элемент);
- ключевое слово ```FROM``` и имя таблицы, из которой выбираются данные;
- необязательное предложение ```WHERE```;
- необязательное предложение ```GROUP BY```;
- необязательное предложение ```HAVING```.

Вложенные запросы  могут включаться в ```WHERE``` или ```HAVING``` так (в квадратных скобках указаны необязательные элементы, через | – один из элементов):

```WHERE``` | ```HAVING``` выражение оператор_сравнения (вложенный запрос);
```WHERE``` | ```HAVING``` выражение, включающее вложенный запрос;
```WHERE``` | ```HAVING``` выражение ```[NOT```] ```IN``` (вложенный запрос);
```WHERE``` | ```HAVING``` выражение  оператор_сравнения  ```ANY``` | ```ALL``` (вложенный запрос).

Также вложенные запросы могут вставляться в основной запрос после ключевого слова ```SELECT```.

Все запросы в данном уроке будут формулироваться для таблицы **book** (создание, заполнение):

```SQL
DROP TABLE IF EXISTS book;

CREATE TABLE book
(
    book_id INT PRIMARY KEY AUTO_INCREMENT,
    title   VARCHAR(50),
    author  VARCHAR(30),
    price   DECIMAL(8, 2),
    amount  INT
);

INSERT INTO book (title, author, price, amount)
VALUES ('Мастер и Маргарита', 'Булгаков М.А.', 670.99, 3),
       ('Белая гвардия', 'Булгаков М.А.', 540.50, 5),
       ('Идиот', 'Достоевский Ф.М.', 460.00, 10),
       ('Братья Карамазовы', 'Достоевский Ф.М.', 799.01, 3),
       ('Игрок', 'Достоевский Ф.М.', 480.50, 10),
       ('Стихотворения и поэмы', 'Есенин С.А.', 650.00, 15);

SELECT * FROM book;

+---------+-----------------------+------------------+--------+--------+
| book_id | title                 | author           | price  | amount |
+---------+-----------------------+------------------+--------+--------+
| 1       | Мастер и Маргарита    | Булгаков М.А.    | 670.99 | 3      |
| 2       | Белая гвардия         | Булгаков М.А.    | 540.50 | 5      |
| 3       | Идиот                 | Достоевский Ф.М. | 460.00 | 10     |
| 4       | Братья Карамазовы     | Достоевский Ф.М. | 799.01 | 3      |
| 5       | Игрок                 | Достоевский Ф.М. | 480.50 | 10     |
| 6       | Стихотворения и поэмы | Есенин С.А.      | 650.00 | 15     |
+---------+-----------------------+------------------+--------+--------+
```

### Оглавление
1. [Вложенный запрос, возвращающий одно значение](#Вложенный-запрос-возвращающий-одно-значение)
2. [Использование вложенного запроса в выражении](#Использование-вложенного-запроса-в-выражении)
3. [Вложенный запрос, оператор IN](#Вложенный-запрос-оператор-IN)
4. [Вложенный запрос, операторы ANY и ALL](#Вложенный-запрос-операторы-ANY-и-ALL)
5. [Вложенный запрос после SELECT](#Вложенный-запрос-после-SELECT)

## Вложенный запрос, возвращающий одно значение
Вложенный запрос, возвращающий одно значение, может использоваться в условии отбора записей ```WHERE``` как обычное значение
совместно с операциями =, <>, >=, <=, >, <.

**Пример**

Вывести информацию о самых дешевых книгах, хранящихся на складе.

Для реализации этого запроса нам необходимо получить минимальную цену из столбца **price** таблицы **book**, а затем вывести
информацию о тех книгах, цена которых  равна минимальной. Первая часть  – поиск  минимума – реализуется вложенным запросом.

*Запрос:*

```SQL
SELECT title, author, price, amount
FROM book
WHERE price = (
         SELECT MIN(price) 
         FROM book
      );
```

*Результат:*

```SQL
+-------+------------------+--------+--------+
| title | author           | price  | amount |
+-------+------------------+--------+--------+
| Идиот | Достоевский Ф.М. | 460.00 | 10     |
+-------+------------------+--------+--------+
```

Вложенный запрос определяет минимальную цену книг во всей таблице (это 460.00), а затем в основном запросе для каждой записи
проверяется, равна ли цена минимальному значению, если равна, информация о книге включается в результирующую таблицу запроса.

**Рекомендация**. При использовании вложенного запроса рекомендуется сначала проверить, правильно ли он работает (занести текст
запроса в окно кода и нажать черную кнопку **Запустить**), если выдается верный результат – использовать код в качестве вложенного запроса.

[:arrow_up:Оглавление](#Оглавление)

___
## Использование вложенного запроса в выражении
Вложенный запрос, возвращающий одно значение, может использоваться в выражениях как обычный операнд, например, к нему
можно что-то прибавить, вычесть и пр.

**Пример**

Вывести информацию о книгах, количество экземпляров которых отличается от среднего количества экземпляров книг на складе
более чем на 3. То есть нужно вывести и те книги, количество экземпляров которых меньше среднего на 3, или больше среднего на 3.

*Запрос:*

```SQL
SELECT title, author, amount 
FROM book
WHERE ABS(amount - (SELECT AVG(amount) FROM book)) >3;
```

*Результат:*

```SQL
+-----------------------+------------------+--------+
| title                 | author           | amount |
+-----------------------+------------------+--------+
| Мастер и Маргарита    | Булгаков М.А.    | 3      |
| Братья Карамазовы     | Достоевский Ф.М. | 3      |
| Стихотворения и поэмы | Есенин С.А.      | 15     |
+-----------------------+------------------+--------+
```

[:arrow_up:Оглавление](#Оглавление)

___
## Вложенный запрос, оператор IN
Вложенный запрос может возвращать несколько значений одного столбца.  Тогда его можно использовать в разделе ```WHERE``` совместно с оператором ```IN```.

```SQL
WHERE имя_столбца IN (вложенный запрос, возвращающий один столбец)
```
Оператор ```IN``` определяет, совпадает ли значение столбца с одним из значений, содержащихся во вложенном запросе. При этом
логическое выражение после ```WHERE``` получает значение истина. Оператор ```NOT IN``` выполняет обратное действие – выражение
истинно, если значение столбца не содержится во вложенном запросе.

**Пример**

Вывести информацию о книгах тех авторов, общее количество экземпляров книг которых не менее 12.

*Запрос:*

```SQL
SELECT title, author, amount, price
FROM book
WHERE author IN (
        SELECT author 
        FROM book 
        GROUP BY author 
        HAVING SUM(amount) >= 12
      );

*Результат:*

```SQL
+-----------------------+------------------+--------+--------+
| title                 | author           | amount | price  |
+-----------------------+------------------+--------+--------+
| Идиот                 | Достоевский Ф.М. | 10     | 460.00 |
| Братья Карамазовы     | Достоевский Ф.М. | 3      | 799.01 |
| Игрок                 | Достоевский Ф.М. | 10     | 480.50 |
| Стихотворения и поэмы | Есенин С.А.      | 15     | 650.00 |
+-----------------------+------------------+--------+--------+
```

Вложенный запрос отбирает двух авторов (Достоевского и Есенина). А в основном запросе для каждой записи таблицы **book**  проверяется, 
входит ли автор книги в отобранный список, если входит - информация о книге включается в запрос.

[:arrow_up:Оглавление](#Оглавление)

___
## Вложенный запрос, операторы ANY и ALL
Вложенный запрос, возвращающий несколько значений одного столбца, можно использовать для отбора записей с помощью
операторов ```ANY``` и ```ALL``` совместно с операциями отношения (=, <>, <=, >=, <, >).

Операторы ```ANY``` и ```ALL``` используются  в SQL для сравнения некоторого значения с результирующим набором вложенного запроса,
состоящим из одного столбца. При этом тип данных столбца, возвращаемого вложенным запросом, должен совпадать с типом
данных столбца (или выражения), с которым происходит сравнение.

При использовании оператора ```ANY``` в результирующую таблицу будут включены все записи, для которых  выражение со знаком
отношения верно хотя бы для одного элемента результирующего запроса. Как работает оператор ```ANY```:
- ```amount > ANY (10, 12)``` эквивалентно ```amount > 10```
- ```amount < ANY (10, 12)``` эквивалентно ```amount < 12```
- ```amount = ANY (10, 12)``` эквивалентно ```(amount = 10) OR (amount = 12)```, а также ```amount IN  (10,12)```
- ```amount <> ANY (10, 12)``` вернет все записи с любым значением amount, включая 10 и 12

При использовании оператора ```ALL``` в результирующую таблицу будут включены все записи, для которых  выражение со знаком
отношения верно для всех элементов результирующего запроса. Как работает оператор ```ALL```:
- ```amount > ALL (10, 12)``` эквивалентно ```amount > 12```
- ```amount < ALL (10, 12)``` эквивалентно ```amount < 10```
- ```amount = ALL (10, 12)``` не вернет ни одной записи, так как эквивалентно ```(amount = 10) AND (amount = 12)```
- ```amount <> ALL (10, 12)``` вернет все записи кроме тех,  в которыхamount равно 10 или 12

**Важно!** Операторы ```ALL``` и ```ANY``` можно использовать только с вложенными запросами. В примерах выше (10, 12) приводится как
результат вложенного запроса просто для того, чтобы показать как эти операторы работают. В запросах так записывать нельзя.

___
**Пример**

Вывести информацию о тех книгах, количество которых меньше самого маленького среднего количества книг каждого автора.

*Запрос:*

```SQL
SELECT title, author, amount, price
FROM book
WHERE amount < ALL (
        SELECT AVG(amount) 
        FROM book 
        GROUP BY author 
      );
```

*Результат:*

```SQL
+--------------------+------------------+--------+--------+
| title              | author           | amount | price  |
+--------------------+------------------+--------+--------+
| Мастер и Маргарита | Булгаков М.А.    | 3      | 670.99 |
| Братья Карамазовы  | Достоевский Ф.М. | 3      | 799.01 |
+--------------------+------------------+--------+--------+
```

**Пояснение:**

1. Вложенный запрос

```SQL
SELECT AVG(amount) 
        FROM book 
        GROUP BY author
отбирает следующие записи:

+-------------+
| AVG(amount) |
+-------------+
| 4.0000      |
| 7.6667      |
| 15.0000     |
+-------------+
```

2. Условие отбора в основном запросе

```SQL
amount < ALL (
        SELECT AVG(amount) 
        FROM book 
        GROUP BY author 
      )
```

можно переписать (если заменить вложенный запрос списком отобранных значений):

```SQL
amount < ALL ( 4.0000, 7.6667, 15.0000)
```

что в соответствии с определением ```ALL```, это значит, что подходят все **amount** меньшие **4.000**.

Таким образом, наш запрос отобрал все книги книги **Мастер и Маргарита** и **Братья Карамазовы**, количество которых равно 3. 

___
**Пример**

Вывести информацию о тех книгах, количество которых меньше самого большого среднего количества книг каждого автора.

*Запрос:*

```SQL
SELECT title, author, amount, price
FROM book
WHERE amount < ANY (
        SELECT AVG(amount) 
        FROM book 
        GROUP BY author 
      );
```

*Результат:*

```SQL
+--------------------+------------------+--------+--------+
| title              | author           | amount | price  |
+--------------------+------------------+--------+--------+
| Мастер и Маргарита | Булгаков М.А.    | 3      | 670.99 |
| Белая гвардия      | Булгаков М.А.    | 5      | 540.50 |
| Идиот              | Достоевский Ф.М. | 10     | 460.00 |
| Братья Карамазовы  | Достоевский Ф.М. | 3      | 799.01 |
| Игрок              | Достоевский Ф.М. | 10     | 480.50 |
+--------------------+------------------+--------+--------+
```

**Пояснение**:

В этом примере ```amount < ANY ( 4.0000, 7.6667, 15.0000)```  означает, что подходят **amount** меньше самого большого значения из списка.

[:arrow_up:Оглавление](#Оглавление)

___
## Вложенный запрос после SELECT
Вложенный запрос может располагаться после ключевого слова ```SELECT```. В этом случае результат выполнения запроса выводится в
отдельном столбце результирующей таблицы. При этом результатом запроса может быть только одно значение, тогда оно будет
повторяться во всех строках. Также вложенный запрос может использоваться в выражениях.

**Пример**

Вывести информацию о книгах, количество экземпляров которых отличается от среднего количества экземпляров книг на складе более чем на 3,  
а также указать среднее значение количества экземпляров книг.

*Запрос*:

```SQL
SELECT title, author, amount, 
    (
     SELECT AVG(amount) 
     FROM book
    ) AS Среднее_количество 
FROM book
WHERE abs(amount - (SELECT AVG(amount) FROM book)) >3;
```

**Пояснение:**

В запросе используется функция [модуля](https://learn.microsoft.com/ru-ru/sql/t-sql/functions/abs-transact-sql?view=sql-server-ver16), 
которая позволяет учесть, что количество может отличаться от среднего как в большую, так и в меньшую сторону.

*Результат:*

```SQL
+-----------------------+------------------+--------+--------------------+
| title                 | author           | amount | Среднее_количество |
+-----------------------+------------------+--------+--------------------+
| Мастер и Маргарита    | Булгаков М.А.    | 3      | 7.6667             |
| Братья Карамазовы     | Достоевский Ф.М. | 3      | 7.6667             |
| Стихотворения и поэмы | Есенин С.А.      | 15     | 7.6667             |
+-----------------------+------------------+--------+--------------------+
```

Во вложенном запросе вычисляется среднее количество экземпляров книг на складе. Этот запрос используется и в условии отбора,
и для создания столбца **Среднее_количество** в результирующей таблице запроса. Значения  столбца одинаковы во всех строках,
поскольку  вложенный запрос возвращает одно значение.

Среднее количество в виде дробного числа выглядит не очень правильно. Полученное значение можно [округлить "вниз"](https://learn.microsoft.com/ru-ru/sql/t-sql/functions/floor-transact-sql?view=sql-server-ver16)
до ближайшего меньшего целого.

*Запрос:*

```SQL
SELECT title, author, amount, 
      FLOOR((SELECT AVG(amount) FROM book)) AS Среднее_количество 
FROM book
WHERE ABS(amount - (SELECT AVG(amount) FROM book)) >3;
```

*Результат:*

```SQL
+-----------------------+------------------+--------+--------------------+
| title                 | author           | amount | Среднее_количество |
+-----------------------+------------------+--------+--------------------+
| Мастер и Маргарита    | Булгаков М.А.    | 3      | 7                  |
| Братья Карамазовы     | Достоевский Ф.М. | 3      | 7                  |
| Стихотворения и поэмы | Есенин С.А.      | 15     | 7                  |
+-----------------------+------------------+--------+--------------------+
```

[:arrow_up:Оглавление](#Оглавление)

___
