## TASK 1.4.6 [задание на stepik](https://stepik.org/lesson/297514/step/6?unit=279274)
Посчитать сколько и каких экземпляров книг нужно заказать поставщикам, чтобы на складе стало одинаковое количество
экземпляров каждой книги, равное значению самого большего количества экземпляров одной книги на складе. Вывести название
книги, ее автора, текущее количество экземпляров на складе и количество заказываемых экземпляров книг. Последнему столбцу
присвоить имя **Заказ**. В результат не включать книги, которые заказывать не нужно.

**Пояснение**: Поскольку книгу с максимальным количеством экземпляров заказывать не нужно, в условии отбора запроса укажите, что книгу с
максимальным значением количества в результирующую таблицу не включать.

**Решение:**

```SQL
SELECT title, author, amount,
	(
	SELECT MAX(amount)
	FROM book
	) - amount AS Заказ
FROM book 
WHERE amount < (SELECT MAX(amount) FROM book);
```

**Перевод на человеческий:**

```SQL
/*выбери столбцы title, author, amount, создай новый столбец с результатом вложенного запроса и назови его "Заказ"*/
/*во вложенном запросе вычисли максимальное значение в столбце amount из таблицы book*/
/*выбери столбцы основного запроса из таблицы book*/
/*выбери только те строки, в которых значения столбца amount меньше максимального значения столбца amount*/
```

**Результат**:

```SQL
+--------------------+------------------+--------+-------+
| title              | author           | amount | Заказ |
+--------------------+------------------+--------+-------+
| Мастер и Маргарита | Булгаков М.А.    | 3      | 12    |
| Белая гвардия      | Булгаков М.А.    | 5      | 10    |
| Идиот              | Достоевский Ф.М. | 10     | 5     |
| Братья Карамазовы  | Достоевский Ф.М. | 3      | 12    |
| Игрок              | Достоевский Ф.М. | 10     | 5     |
+--------------------+------------------+--------+-------+
Affected rows: 5
```

**Пояснения**

1. В условии сказано, что на складе в результате заказа должно стать **одинаковое** количество экземпляров каждой книги,
**равное значению самого большего количества** экземпляров одной книги на складе. Значит первым делом нам надо узнать какое самое большое количество
и делать все остальные запросы относительно него.

Самое большое количество можно узнать вычислив **макимальное значение** столбца **amount** с помощью агрегатной функции ```MAX```.
Так как агрегатные функции применяются только к группе, мы не можем сразу написать её в ```SELECT``` основного запроса.
Нельзя в одной выборке объединять её с одинарным полем, так как в запросе у нас есть еще поля **title**, **author**, **amount**. Поэтому ёё надо
делать в **отдельном столбце**. А отдельный столбец мы можем сформировать **вложенным запросом**.

2. Разберём вложенный запрос. Он довольно простой: с помощью агрегатной функции ```MAX``` мы вычисляем макимальное значение столбца **amount**
и с этим значением уже можно будет дальше работать.

```SQL
SELECT MAX(amount)
FROM book;
```

Получаем:

```SQL
+-------------+
| MAX(amount) |
+-------------+
| 15          |
+-------------+
```

3. Теперь с помощью этого значения сформируем рассчёт количества, которое нам необходимо дозаказать для того, чтобы каждого экземпляра книги на складе
стало столько же, сколько мы получили в качестве результата вложенного запроса (15).

Для этого нам достаточно из требуемого количества вычесть текущее, в результате получим количество, необходимое для заказа. А новый столбец с результатом
назвать "Заказ" с помощью оператора ```AS```:

```SQL
SELECT title, author, amount,
	(
	SELECT MAX(amount)
	FROM book
	) - amount AS Заказ
FROM book;
```

Получаем временную таблицу:

```SQL
+-----------------------+------------------+--------+-------+
| title                 | author           | amount | Заказ |
+-----------------------+------------------+--------+-------+
| Мастер и Маргарита    | Булгаков М.А.    | 3      | 12    |
| Белая гвардия         | Булгаков М.А.    | 5      | 10    |
| Идиот                 | Достоевский Ф.М. | 10     | 5     |
| Братья Карамазовы     | Достоевский Ф.М. | 3      | 12    |
| Игрок                 | Достоевский Ф.М. | 10     | 5     |
| Стихотворения и поэмы | Есенин С.А.      | 15     | 0     |
+-----------------------+------------------+--------+-------+
```

4. В задаче есть ещё одно условие: **В результат не включать книги, которые заказывать не нужно** с пояснением: в условии отбора запроса укажите, что
книгу с максимальным значением количества в результирующую таблицу не включать.

Значит к нашему запросу добавим ещё условие отбора с помощь оператора ```WHERE```, в котором укажем, что надо отобрать только те строки,
в которых значения столбца **amount** меньше его **максимального значения**.

```SQL
SELECT title, author, amount,
	(
	SELECT MAX(amount)
	FROM book
	) - amount AS Заказ
FROM book 
WHERE amount < (SELECT MAX(amount) FROM book);

Получим окончательный результат:

```SQL
+--------------------+------------------+--------+-------+
| title              | author           | amount | Заказ |
+--------------------+------------------+--------+-------+
| Мастер и Маргарита | Булгаков М.А.    | 3      | 12    |
| Белая гвардия      | Булгаков М.А.    | 5      | 10    |
| Идиот              | Достоевский Ф.М. | 10     | 5     |
| Братья Карамазовы  | Достоевский Ф.М. | 3      | 12    |
| Игрок              | Достоевский Ф.М. | 10     | 5     |
+--------------------+------------------+--------+-------+
Affected rows: 5
```

___
**Решение 2**

Глядя на временную таблицу, можно предположить, что также можно отобрать строки, в которых значение столбца **Заказ** не равно 0. Но так сделать не получится. Тут нужно вспомнить порядок выполнения SQL запроса на выборку на СЕРВЕРЕ: в нашем запросе ```SELECT``` будет выполнять после предложения ```WHERE```.
Поэтому во время выполнения ```WHERE``` на сервере столбец **Заказ** еще не существует.

Но альтернативное решение конечно существует. Можно сделать такое же арифметическое действие, как в основном запросе для формирования столбца **Заказ**:

```SQL
SELECT title, author, amount,
	(
	SELECT MAX(amount)
	FROM book
	) - amount AS Заказ
FROM book 
WHERE (
	SELECT MAX(amount)
	FROM book
	) - amount <> 0;
```

**Результат**:

```SQL
+--------------------+------------------+--------+-------+
| title              | author           | amount | Заказ |
+--------------------+------------------+--------+-------+
| Мастер и Маргарита | Булгаков М.А.    | 3      | 12    |
| Белая гвардия      | Булгаков М.А.    | 5      | 10    |
| Идиот              | Достоевский Ф.М. | 10     | 5     |
| Братья Карамазовы  | Достоевский Ф.М. | 3      | 12    |
| Игрок              | Достоевский Ф.М. | 10     | 5     |
+--------------------+------------------+--------+-------+
Affected rows: 5
```
